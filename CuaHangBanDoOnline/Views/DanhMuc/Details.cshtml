@model CuaHangBanDoOnline.Models.DanhMuc

<div class="container my-4">
    <!-- Hiển thị tiêu đề danh mục -->
    <h1 class="mb-4">@(Model.TenDanhMuc ?? "Tất cả sản phẩm")</h1>

    <!-- Hiển thị thông báo lỗi nếu có -->
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <!-- Search and Filter Section -->
    <form asp-action="@(ViewContext.RouteData.Values["action"].ToString() == "SanPhamTheoDanhMuc" ? "SanPhamTheoDanhMuc" : (ViewContext.RouteData.Values["controller"].ToString() == "Home" ? "Index" : "Details"))"
          asp-controller="@(ViewContext.RouteData.Values["controller"].ToString() == "Home" ? "Home" : "DanhMuc")"
          method="get" class="mb-4">
        @if (ViewContext.RouteData.Values["action"].ToString() == "SanPhamTheoDanhMuc")
        {
            <input type="hidden" name="maDanhMuc" value="@Model.MaDanhMuc" />
        }
        else if (ViewContext.RouteData.Values["controller"].ToString() != "Home")
        {
            <input type="hidden" name="id" value="@Model.MaDanhMuc" />
        }
        <h2 class="text-uppercase mb-3">Tìm kiếm sản phẩm</h2>
        <div class="row g-3 align-items-center">
            <!-- Search Bar -->
            <div class="col-md-3">
                <input type="text" name="search" class="form-control" placeholder="Tìm kiếm sản phẩm..." value="@ViewBag.Search" />
            </div>
            <!-- Filter Dropdowns -->
            <div class="col-md-2">
                <select name="category" class="form-select">
                    <option value="">Tất cả danh mục</option>
                    @foreach (var danhMuc in ViewBag.DanhMucs)
                    {
                        <option value="@danhMuc.MaDanhMuc" selected="@(ViewBag.SelectedCategory == danhMuc.MaDanhMuc.ToString() ? "selected" : null)">@danhMuc.TenDanhMuc</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <select name="priceRange" class="form-select">
                    <option value="">Mức giá</option>
                    <option value="0-500000" selected="@(ViewBag.PriceRange == "0-500000" ? "selected" : null)">Dưới 500,000 VNĐ</option>
                    <option value="500000-1000000" selected="@(ViewBag.PriceRange == "500000-1000000" ? "selected" : null)">500,000 - 1,000,000 VNĐ</option>
                    <option value="1000000-5000000" selected="@(ViewBag.PriceRange == "1000000-5000000" ? "selected" : null)">1,000,000 - 5,000,000 VNĐ</option>
                    <option value="5000000-" selected="@(ViewBag.PriceRange == "5000000-" ? "selected" : null)">Trên 5,000,000 VNĐ</option>
                </select>
            </div>
            <div class="col-md-2">
                <select name="sortBy" class="form-select">
                    <option value="">Sắp xếp</option>
                    <option value="price-asc" selected="@(ViewBag.SortBy == "price-asc" ? "selected" : null)">Giá: Thấp đến Cao</option>
                    <option value="price-desc" selected="@(ViewBag.SortBy == "price-desc" ? "selected" : null)">Giá: Cao đến Thấp</option>
                    <option value="name-asc" selected="@(ViewBag.SortBy == "name-asc" ? "selected" : null)">Tên: A-Z</option>
                    <option value="name-desc" selected="@(ViewBag.SortBy == "name-desc" ? "selected" : null)">Tên: Z-A</option>
                </select>
            </div>
            <!-- Filter Button -->
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary w-100" aria-label="Lọc sản phẩm">Lọc</button>
            </div>
        </div>
    </form>

    <!-- Product Listing Section -->
    <div class="row">
        @if (Model.HangHoaDanhMucs.Any())
        {
            @foreach (var hhdm in Model.HangHoaDanhMucs)
            {
                var hangHoa = hhdm.HangHoa;
                var khuyenMai = hangHoa.KhuyenMais.FirstOrDefault(km => km.NgayBatDau <= DateTime.Now && km.NgayKetThuc >= DateTime.Now);
                int discountPercentage = khuyenMai != null ? (int)khuyenMai.PhanTramGiamGia : 0;

                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="card border-0 shadow-sm position-relative">
                        <img src="@(string.IsNullOrEmpty(hangHoa.Hinh) ? "/images/default-product.jpg" : hangHoa.Hinh)" class="card-img-top" alt="@hangHoa.TenHangHoa" style="height: 200px; object-fit: cover;">
                        @if (discountPercentage > 0)
                        {
                            <span class="badge bg-danger position-absolute top-0 end-0 m-2">Giảm @discountPercentage%</span>
                        }
                        <div class="card-body">
                            <h5 class="card-title" style="font-size: 1.1rem; font-weight: bold; min-height: 48px;">@hangHoa.TenHangHoa</h5>
                            <div class="d-flex align-items-center mb-2">
                                <span class="text-danger fw-bold me-2">@hangHoa.GiaBan.ToString("#,##0") VNĐ</span>
                                @if (discountPercentage > 0)
                                {
                                    <span class="text-muted text-decoration-line-through">@hangHoa.GiaGoc.ToString("#,##0") VNĐ</span>
                                }
                            </div>
                            <a asp-action="Detail" asp-controller="HangHoa" asp-route-id="@hangHoa.MaHangHoa" class="btn btn-primary btn-sm w-100">Chi tiết</a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-muted">Không có sản phẩm nào trong danh mục này.</p>
        }
    </div>
</div>

<!-- Custom CSS for Styling -->
<style>
    .card {
        transition: transform 0.2s;
    }

        .card:hover {
            transform: translateY(-5px);
        }

    .card-img-top {
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    .badge {
        font-size: 0.9rem;
        padding: 5px 10px;
    }

    .text-danger {
        color: #dc3545 !important;
    }

    .form-control, .form-select, .btn-primary {
        border-radius: 5px;
    }

    .btn-primary {
        background-color: #007bff;
        border: none;
    }

        .btn-primary:hover {
            background-color: #0056b3;
        }
</style>